name: Publish to PyPI

on:
  push:
    tags:
      - "v*.*.*" # Match version tags like v2.0.0

jobs:
  build:
    name: Build distribution ğŸ“¦
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: ğŸ“¦ Install uv
        uses: astral-sh/setup-uv@v5

      - name: ğŸ“¦ Install just
        uses: extractions/setup-just@v2

      - name: âœ… Validate version matches tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Extract version from tag (remove 'v' prefix)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Tag version: $TAG_VERSION"

          # Extract version from pyproject.toml
          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | cut -d'"' -f2)
          echo "pyproject.toml version: $PYPROJECT_VERSION"

          # Compare versions
          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "âŒ ERROR: Tag version ($TAG_VERSION) does not match pyproject.toml version ($PYPROJECT_VERSION)"
            exit 1
          fi

          echo "âœ… Version validation passed: $TAG_VERSION"

      - name: ğŸ“¦ Install build dependencies
        run: |
          uv tool install hatch
          uv tool install twine
          uv sync --extra generator

      - name: ğŸ—ï¸ Download schemas and regenerate stubs
        run: just rebuild

      - name: ğŸ—ï¸ Build distribution
        run: uvx hatch build

      - name: ğŸ” Check distribution
        run: uvx twine check dist/*

      - name: ğŸ“¤ Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 7

  publish-to-pypi:
    name: Publish to PyPI ğŸ“¦
    needs: [build]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    environment:
      name: pypi
      url: https://pypi.org/p/pydantic-ocsf
    permissions:
      id-token: write # Required for trusted publishing

    steps:
      - name: ğŸ“¥ Download distribution packages
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: ğŸ“¦ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  create-github-release:
    name: Create GitHub Release
    needs: [publish-to-pypi]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download distribution packages
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: ğŸ·ï¸ Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Release ${{ github.ref_name }}" \
            --notes "See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details." \
            dist/*
